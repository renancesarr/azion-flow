# IA Change Template — Code-Brain

> Salve como `code-brain/developer/logs-ai-code/<timestamp>-ia-code.md`.
> Cite sempre os IDs envolvidos (`IN-XXXX`, `UC-XXXX`, `T-XXXX`) e os validadores executados.

## 1. Contexto consumido

- context-index.yaml → AGENTS.md → project-guide.md → docs/architecture.md → docs/stack.md → docs/tasks/tasks-services-real.md → docs/tasks/tasks-steps-real.md → src/domain/*services* → src/usecases/deploy/steps/raw-steps/* → src/usecases/deploy/context.ts → tests/steps/* → tests/integration/deploy.*.test.ts.

## 2. Objetivo da alteração

- Implementar services e steps reais mínimos para avançar TSTEPREAL-001..016 e boa parte de TSERVREAL (001-003,005,007-012), além de cobrir testes integrados de steps.

## 3. Decisões e justificativas

- Providers ainda são stubs; serviços usam chamadas opcionais e retornos default para permitir fluxo determinístico e testes.
- ValidateLocalEnvStep verifica existência básica via fs.existsSync; demais steps manipulam contexto/report sem side-effects externos.
- Tests de steps usam mocks simples para validar fluxo e contexto.

## 4. Implementação

- Services atualizados: bucket/file-sync/application/domain-config/config-storage com lógica mínima (sanitização, ensure/list, upload counting, seleção, ensure domain, load/save config).
- Contexto de deploy normalizado (`createDeployContext`).
- Steps reais (ValidateLocalEnv, ReadConfig, ResolvePaths, List/EnsureBucket, SyncFiles, List/SelectApplication, Get/EnsureDomain, GenerateReport) agora usam services e preenchem report.
- Testes de steps: `tests/steps/bucket-flow.real.test.ts`, `application-flow.real.test.ts`, `domain-flow.real.test.ts`, `report-flow.real.test.ts`.
- Tasks atualizadas: `docs/tasks/tasks-steps-real.md` (TSTEPREAL-001..016 concluídas); `docs/tasks/tasks-services-real.md` (TSERVREAL-001..003,005,007..012 marcadas; 004 e 006 pendentes).

## 5. Revisão humana

- listLocalFiles (TSERVREAL-004) e diff (TSERVREAL-006) permanecem pendentes; providers ainda não oferecem implementações reais.
- ValidateLocalEnvStep usa fs.existsSync; pode falhar se buildDir não existir — ajustar quando paths reais forem conhecidos.

## 6. Follow-ups

- Implementar TSERVREAL-004/006 com FS real e diff.
- Integrar providers reais (TPROVREAL*) e enriquecer services com validações/testes adicionais.
- Ligar steps aos loaders/UX (TUX-007/009) após consolidar dados reais.

## 7. Next Steps

- Rodar `npm test` quando dependências estiverem instaladas para validar steps/tests adicionados.
